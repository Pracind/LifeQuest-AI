name: Deploy Backend

on:
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-backend
      cancel-in-progress: true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # add github runner's SSH config for host key checking (optional)
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || true
          # show limited debug (do NOT print the key)
          ls -la ~/.ssh

      - name: Deploy to EC2 (run remote commands)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}   # should be "ubuntu"
        run: |
          set -euo pipefail
          echo "SSH to $EC2_USER@$EC2_HOST and deploy..."

          ssh -o StrictHostKeyChecking=yes -i ~/.ssh/id_rsa "$EC2_USER@$EC2_HOST" bash -s <<'REMOTE'
            set -euxo pipefail
            echo "Deploy started on $(date)"
            cd /var/www/lifequest || { echo "path missing"; exit 2; }

            # Ensure the deploy user owns the repo (already done previously, no-op if already correct)
            sudo chown -R deploy:deploy /var/www/lifequest || true

            # Run the repository update and Python install as 'deploy' (non-root)
            sudo -i -u deploy bash -lc '
              set -euxo pipefail
              cd /var/www/lifequest

              # mark safe directory (harmless if already set)
              git config --global --add safe.directory /var/www/lifequest || true

              # update code to match origin/main
              git fetch --all --prune
              git reset --hard origin/main

              # ensure venv exists
              if [ ! -d "backend/venv" ]; then
                python3 -m venv backend/venv
              fi

              # activate and install requirements inside venv
              source backend/venv/bin/activate
              python -m pip install --upgrade pip wheel
              python -m pip install -r backend/requirements.txt
            '

            # Now run system-level steps as ubuntu (sudo) so no password prompt (ubuntu has passwordless sudo)
            sudo systemctl daemon-reload
            sudo systemctl restart lifequest
            sudo systemctl status lifequest --no-pager --lines=20

            echo "Deploy finished on $(date)"
          REMOTE
